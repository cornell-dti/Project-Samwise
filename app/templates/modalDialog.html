<script type='text/javascript'>
	$(document).ready(function() {
        // page is now ready, initialize the calendar...


        var intromodal = document.getElementById('introModal');
				var modal = document.getElementById('myModal');
				var modalevent = document.getElementById('eventModal');
        var notModal = document.getElementById('notificationModal');
				var displayProjectModal = document.getElementById('addProjectModal');
				var welcomeModal = document.getElementById("welcomeModal");
				var eventDetailsModal = document.getElementById("eventDetailsModal");

				var closeDetails = document.getElementById("closeEventDetails");
				closeDetails.onclick = function(){
					var info = document.getElementById("information");
					info.innerHTML = "";
					eventDetailsModal.style.display = 'none';
				}
				var closeIntro = document.getElementById("closeIntro");
				closeIntro.onclick = function(){
					document.getElementById("classSearchIntro").value = "";
					intromodal.style.display = 'none';
				}
				var closeProject = document.getElementById("closeProject");
				closeProject.onclick = function(){
					displayProjectModal.style.display = 'none';
				}
				var closeNot = document.getElementById("closeNotification");
				closeNot.onclick = function(){
					notModal.style.display = 'none';
				}

        var courseAddButton = document.getElementById('courseAdd');
        var eventAddButton = document.getElementById('eventAdd');
        var input = document.getElementById("nameOne");

				document.addEventListener("DOMContentLoaded", function() {
	        var awesomplete = new Awesomplete(input, {
					  minChars: 0,
					  autoFirst: true
					});
				});

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }

            if (event.target == modalevent) {
            	modalevent.style.display = 'none';
            }

            if (event.target == intromodal) {
                intromodal.style.display = 'none';
            }

            if (event.target == notModal) {
                notModal.style.display = 'none';
            }

						if (event.target == displayClassModal){
							displayClassModal.style.display = 'none';
						}

						if (event.target == displayProjectModal){
							displayProjectModal.style.display = 'none';
						}
        }

    });


    document.addEventListener('DOMContentLoaded', function () {
      if (Notification.permission !== "granted")
        Notification.requestPermission();
    });

    function sendEmail() {
    	window.open('mailto:kl553@cornell.edu?subject=SA%20Tech%20Email%20Notification');
    }

    function notifyMe() {


      if (!Notification) {
        alert('Desktop notifications not available in your browser. Try Chromium.');
        return;
      }

      if (Notification.permission !== "granted")
        Notification.requestPermission();
      else {
        var notification = new Notification('Notification title', {
          icon: 'https://avatars1.githubusercontent.com/u/19356609?v=3&s=200',
          body: "Hey there! You've been notified!",
        });

        notification.onclick = function () {
          window.open("http://www.cornelldti.org/");
        };
      }
    }

    function introAdd() {
        var modal = document.getElementById('introModal');
				document.getElementById("classSearchIntro").value = "";
        modal.style.display = 'block';
    }


		function displayProjectModal() {
			var modal = document.getElementById('addProjectModal');
			populateProjectTagSelect();
			modal.style.display = 'block';
		}

    function addingClass() {
        var modal = document.getElementById('eventModal');
        modal.style.display = 'block';
    }

    function switchClass() {
        var modal = document.getElementById('introModal');
        modal.style.display = 'none';
        var modal2 = document.getElementById('eventModal');
        modal2.style.display = 'block';
    }

    function switchCouse() {
        var modal = document.getElementById('introModal');
        modal.style.display = 'none';
        var modal2 = document.getElementById('myModal');
        modal2.style.display = 'block';

		$.getJSON('http://localhost:5000/getAllClasses', function(data) {
		  //data is the JSON string
		  awesomplete.list = data;
		});
    }

    function desktopToggle() {
        var modal = document.getElementById('notificationModal');
        modal.style.display = 'block';
    }

    function eventToggle() {
        var modal = document.getElementById('eventModal');
        modal.style.display = 'block';
    }

    function goButton(modalType) {
    	var modal = document.getElementById(modalType);
    	modal.style.display = 'none';
    }


		function addProjectToCalendar(){

			var name = document.getElementById("projectName").value;
			var date = document.getElementById("projectDate").value;
			var course = document.getElementById("selectDropdown").value;
			var start = document.getElementById("startWorking").value;
			var realstart = document.getElementById("realstart").value;
			var pLocation = document.getElementById("projectLocation").value;
			var notes = document.getElementById("projectNotes").value;

			if (name === 'undefined'){
				name = "Empty"
			}
			if (date){
				date = date.concat(":00");

			}
			else{
				var today = new Date();
				var date = today.toISOString();
				console.log(date);
			}

			if (realstart){
				realstart = realstart.concat(":00");
			}
			else{
				realstart = date;
			}
			if (course === 'undefined'){
				course = "Blank";
			}
			// if (start < 1){
			// 	start = 1;
			// }
			var startWorkingDateObj = new Date(realstart);
			startWorkingDateObj.setDate(startWorkingDateObj.getDate() - start);
			startWorkingDateObj.setTime(startWorkingDateObj.getTime() - (5 * 60 * 60 * 1000));
			var startDate = startWorkingDateObj.toISOString();

			var dateObj = new Date(date);
			dateObj.setTime(dateObj.getTime() - (5 * 60 * 60 * 1000));
			date = dateObj.toISOString();
			console.log(date);

			var c = getUserCourseColor(userid, course);
			var newEvent = {
				title : name,
				start : startDate,
				end : date,
				tag : course,
				color : c,
				notes : notes,
				location : pLocation
			}

			$("#calendar").fullCalendar('addEventSource', [newEvent]);
			$("#calendar").fullCalendar('rerenderEvents');

			addEvent(userid, name, startDate, date, course, pLocation, notes);

			var modal = document.getElementById('addProjectModal');
			modal.style.display = 'none';
		}

		function addStoredEvents(){

			var exams = getUserExams(userid);
			if (exams.length < 1){
				return;
			}
			for (k = 0; k < exams.length; k++){
				for (j = 0; j < exams[k].length; j++){

					var date = exams[k][j].start;
					date = date.split(", ");

					//07 Dec 2017 09:00:00 GMT must become
					//2010-01-09T12:30:00

					date = date[1].split(" ");
					function getMonthFromString(mon){
					   return new Date(Date.parse(mon +" 1, 2012")).getMonth()+1
					}
					var monthNum = getMonthFromString(date[1]);

					var dateString = date[2] + "-" + parseInt(monthNum) +
										"-" + date[0] + "T" + date[3];

					if (exams[k][j].courseId === 'undefined'){
						continue;
					}
					else{
						var startWorkingExam = new Date(dateString);
						startWorkingExam.setDate(startWorkingExam.getDate() - 7);
						var startDate = startWorkingExam.toISOString();
						var c = getUserCourseColor(userid, exams[k][j].courseId);
						var newEvent = {
							title : exams[k][j].courseId,
							start : startDate,
							end : dateString,
							tag : exams[k][j].courseId,
							color : c,
							location : exams[k][j].location,
							notes : exams[k][j].notes
						}

						$("#calendar").fullCalendar('addEventSource', [newEvent]);
					}


				}
			}


			var events = getEvents(userid);
			for (k = 0; k < events.length; k++){
				var c = getUserCourseColor(userid, events[k].tagId);
				console.log("TAG" + events[k].eventName + " " + events[k].tagId);
				var newEvent = {
					title : events[k].eventName,
					start : events[k].startTime,
					end : events[k].endTime,
					tag : events[k].tagid,
					color : c,
					notes : events[k].notes,
					location : events[k].location
				}
				$("#calendar").fullCalendar('addEventSource', [newEvent]);
			}
			$("#calendar").fullCalendar('rerenderEvents');
		}

		function remove(link) {
				removeCourse(userid, link.innerHTML);
		    link.parentNode.parentNode.removeChild(link.parentNode);
		}

		function populateUserCourses(){
			var userCourses = getUserCourses(userid);
			console.log(userCourses);
			if (userCourses.length < 1){
				return;
			}
			var lst = document.getElementById("currentClasses");
			$('#currentClasses').empty();
			for (i = 0; i < userCourses.length; i++){
				var li = document.createElement("li");
				var a = document.createElement("a");
				a.setAttribute("href", "#");
				a.setAttribute("onclick", "remove(this)");
				var t = document.createTextNode(userCourses[i]);
				a.append(t);
				li.append(a);

				lst.append(li);
			}
		}

		function populateProjectTagSelect(){
			var userCourses = getUserCourses(userid);
			if (userCourses.length < 1){
				return;
			}
			var dropdown = document.getElementById("selectDropdown");
			$('#selectDropdown').empty();
			for (i = 0; i < userCourses.length; i++){
				var opt = document.createElement("option");
				opt.setAttribute("value", userCourses[i]);
				var t = document.createTextNode(userCourses[i]);
				opt.append(t);

				dropdown.append(opt);
			}
		}

		function displayIntroModal(){
			var userCourses = getUserCourses(userid);
			if (userCourses.length == 0){
				var introModal = document.getElementById("introModal");
				introModal.style.display = 'block';
			}
		}

		function addUserClass(){
			var className = document.getElementById("classSearchIntro").value;
			var currClasses = getUserCourses(userid);
			if (currClasses.length > 0){
				for (i = 0; i < currClasses.length; i++){
					if (currClasses[i] == className){
						console.log("already have this class");
						return;
					}
				}
			}
			if (className.length > 0){
				addCourse(userid, className);
				console.log(className);
				populateUserCourses();
			}
		}

		function updateCalendar(){
			var events = $("#calendar").fullCalendar('getEventSources');
			var userEvents = getEvents(userid);
			var eventObjs = [];
			for (k = 0; k < events.length; k++){
				for (x = 0; x < events[k].events.length; x++){
					eventObjs.push(events[k].events[x]);
				}
			}
			var lst = document.getElementById("currentClasses").getElementsByTagName("li");
			var lstPrime = [];
			for (j = 0; j < lst.length; j++){
				lstPrime.push(lst[j].getElementsByTagName("a")[0].innerHTML);
			}

			// for (i = 0; i < eventObjs.length; i++){
			// 	if (eventObjs[i].className.length == 1 && lstPrime.indexOf(eventObjs[i].className[0]) == -1){
			// 		console.log(eventObjs[i].className[0] + " " + eventObjs[i].title);
			// 		removeEvent(eventObjs[i].title);
			// 	}
			// }
			for (i = 0; i < userEvents.length; i++){
				console.log(userEvents[i]);
				if (userEvents[i].tagId.length > 0 && lstPrime.indexOf(userEvents[i].tagId) == -1){
					console.log(userEvents[i].eventId + " " + userEvents[i].eventName);
					removeEvent(userEvents[i].eventId);
				}
			}
			$("#calendar").fullCalendar('removeEvents');

			addStoredEvents();
			syncGoogleToFullCalendar();

			$("#calendar").fullCalendar('rerenderEvents');
			introModal.style.display = 'none';
		}

		function nospaces(t){
        if(t.value.match(/\s|\./g)){
            t.value=t.value.replace(/\s/g,'');
        }
    }

</script>

<div id = "eventDetailsModal" class="modal" style="display:none;">
	<div class = "small-modal" id="eventDetaislModalContent">
		<div class = "modal-header">
			<span class="close" id="closeEventDetails">&times;</span>
 			<div id = "information"></div>
		</div>
	</div>
</div>

<div id = "addProjectModal" class="modal" style= "display:none;">
	<div class="modal-content">
	 <div class="modal-header" style="background-color: rgba(255, 5, 35, 1); opacity: 0.7">
		 <span class="close" id="closeProject">&times;</span>
			<div class = "col-sm-12">
				<h3>Add New</h3>
				 <input style= "color: white" class= "task_name" type="text" id ="projectName" placeholder="Title"> <br>
				 <div class = "col-sm-4"></div>
	 			<br>
	 		  <br>
	 			<br>
	 			<br>

					<div class = "col-sm-2 title">
						Tag
					</div>
					<select style="color: black" id = "selectDropdown"></select>

				<br><br>
				<div class = "col-sm-2 title">
					Starts
				</div>
				<input type="datetime-local" style="color: black; width:200px"id="realstart">
				<br>
				<br>
				<div class = "col-sm-2 title">
					Ends
				</div>
				<input type="datetime-local" style="color: black; width:200px"id="projectDate">
				<br>
				<br>
				<br>
				<div class = "col-sm-2 title">
					Start working
				</div>
				<input class = "col-sm-1 start_working" type="number" style="color: black; width:80px" id="startWorking" value="0">
				<div class = "col-sm-2 title days-ahead">Days Ahead</div>
				<br><br>

				<br>
				<div class = "col-sm-2 title">
					Location
				</div>
					<input style= "color: white" class= "project_location" type="text" id ="projectLocation" placeholder="Event Location Here">
				<div class = "col-sm-2 title">
					Notes
				</div>
					<input style= "color: white" class= "project_notes" type="text" id ="projectNotes" placeholder="Enter Event Notes Here">
			 </div>

				<button class="btn btn-lg btn-default" style="float:right;" onclick="addProjectToCalendar()">Save</button>

				<br>
				<br>
			</div>
		 </div>
	 </div>
</div>




<div id="introModal" class="modal" style= "display:none;">

		      <!-- Modal content -->
		      <div class="modal-content">
			<div class="modal-header" style="background-color: #4a4a4a;" >
			<span class = "close" id = "closeIntro">&times;</span>
			  <h2>Settings</h2>

					<div class = "col-sm-2">
						<h4>Add classes</h4>
					</div>

						<input style="background-color: white; color: black;" id="classSearchIntro"
						type="text" class = "classSearch" placeholder="Search Classes at Cornell" onkeyup="nospaces(this)"
						/>
						<button class="btn btn-sm btn-default" style="float:right;" onclick="addUserClass()">Save</button>
						<br><br>
						<h4>Current classes and tags (click to remove):</h4>
						<ul id = "currentClasses">
						</ul>

						<button class="btn btn-sm btn-default" style="float:right;" onclick="updateCalendar()">Save tags</button>

			</div>

		      </div>

		    </div>


<div id="notificationModal" class="modal">
		      <!-- Modal content -->
	  <div class="modal-content">
			<div class="modal-header" style="background-color: #4a4a4a;">
			  <span class="close" id="closeNotification">&times;</span>
			  <h2>Notification Settings</h2>
				</div>
				<div class="modal-body" style="background-color: #4a4a4a;">
				</div>
			<div class="modal-footer" style="background-color: #4a4a4a;">
			</div>
	  </div>

</div>
